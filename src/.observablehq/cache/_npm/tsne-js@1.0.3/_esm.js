/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/tsne-js@1.0.3/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import t from"../ndarray@1.0.19/_esm.js";import e from"../ndarray-ops@1.2.2/_esm.js";import r from"../ndarray-pack@1.2.1/_esm.js";import n from"../ndarray-unpack@1.0.0/_esm.js";import i from"../cwise@1.0.10/_esm.js";function a(t){return t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var s={exports:{}};function o(){}function u(){u.init.call(this)}function l(t){return void 0===t._maxListeners?u.defaultMaxListeners:t._maxListeners}function f(t,e,r,n){var i,a,s,u;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((a=t._events)?(a.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),a=t._events),s=a[e]):(a=t._events=new o,t._eventsCount=0),s){if("function"==typeof s?s=a[e]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),!s.warned&&(i=l(t))&&i>0&&s.length>i){s.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+e+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=t,f.type=e,f.count=s.length,u=f,"function"==typeof console.warn?console.warn(u):console.log(u)}}else s=a[e]=r,++t._eventsCount;return t}function d(t,e,r){var n=!1;function i(){t.removeListener(e,i),n||(n=!0,r.apply(t,arguments))}return i.listener=r,i}function h(t){var e=this._events;if(e){var r=e[t];if("function"==typeof r)return 1;if(r)return r.length}return 0}function p(t,e){for(var r=new Array(e);e--;)r[e]=t[e];return r}o.prototype=Object.create(null),u.EventEmitter=u,u.usingDomains=!1,u.prototype.domain=void 0,u.prototype._events=void 0,u.prototype._maxListeners=void 0,u.defaultMaxListeners=10,u.init=function(){this.domain=null,u.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new o,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},u.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},u.prototype.getMaxListeners=function(){return l(this)},u.prototype.emit=function(t){var e,r,n,i,a,s,o,u="error"===t;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(e=arguments[1],!o){if(e instanceof Error)throw e;var l=new Error('Uncaught, unspecified "error" event. ('+e+")");throw l.context=e,l}return e||(e=new Error('Uncaught, unspecified "error" event')),e.domainEmitter=this,e.domain=o,e.domainThrown=!1,o.emit("error",e),!1}if(!(r=s[t]))return!1;var f="function"==typeof r;switch(n=arguments.length){case 1:!function(t,e,r){if(e)t.call(r);else for(var n=t.length,i=p(t,n),a=0;a<n;++a)i[a].call(r)}(r,f,this);break;case 2:!function(t,e,r,n){if(e)t.call(r,n);else for(var i=t.length,a=p(t,i),s=0;s<i;++s)a[s].call(r,n)}(r,f,this,arguments[1]);break;case 3:!function(t,e,r,n,i){if(e)t.call(r,n,i);else for(var a=t.length,s=p(t,a),o=0;o<a;++o)s[o].call(r,n,i)}(r,f,this,arguments[1],arguments[2]);break;case 4:!function(t,e,r,n,i,a){if(e)t.call(r,n,i,a);else for(var s=t.length,o=p(t,s),u=0;u<s;++u)o[u].call(r,n,i,a)}(r,f,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(n-1),a=1;a<n;a++)i[a-1]=arguments[a];!function(t,e,r,n){if(e)t.apply(r,n);else for(var i=t.length,a=p(t,i),s=0;s<i;++s)a[s].apply(r,n)}(r,f,this,i)}return!0},u.prototype.addListener=function(t,e){return f(this,t,e,!1)},u.prototype.on=u.prototype.addListener,u.prototype.prependListener=function(t,e){return f(this,t,e,!0)},u.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,d(this,t,e)),this},u.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,d(this,t,e)),this},u.prototype.removeListener=function(t,e){var r,n,i,a,s;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(r=n[t]))return this;if(r===e||r.listener&&r.listener===e)0==--this._eventsCount?this._events=new o:(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(i=-1,a=r.length;a-- >0;)if(r[a]===e||r[a].listener&&r[a].listener===e){s=r[a].listener,i=a;break}if(i<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new o,this;delete n[t]}else!function(t,e){for(var r=e,n=r+1,i=t.length;n<i;r+=1,n+=1)t[r]=t[n];t.pop()}(r,i);n.removeListener&&this.emit("removeListener",t,s||e)}return this},u.prototype.off=function(t,e){return this.removeListener(t,e)},u.prototype.removeAllListeners=function(t){var e,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new o,this._eventsCount=0):r[t]&&(0==--this._eventsCount?this._events=new o:delete r[t]),this;if(0===arguments.length){for(var n,i=Object.keys(r),a=0;a<i.length;++a)"removeListener"!==(n=i[a])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=new o,this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(e)do{this.removeListener(t,e[e.length-1])}while(e[0]);return this},u.prototype.listeners=function(t){var e,r=this._events;return r&&(e=r[t])?"function"==typeof e?[e.listener||e]:function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(e):[]},u.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):h.call(t,e)},u.prototype.listenerCount=h,u.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var c=a(Object.freeze({__proto__:null,default:u,EventEmitter:u})),v={exports:{}};!function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(t,e){for(var r=new Float64Array(t*e),n=0;n<r.length;n++)r[n]=1e-4*a();return(0,i.default)(r,[t,e])};var n,i=(n=t)&&n.__esModule?n:{default:n};function a(){var t=2*Math.random()-1,e=2*Math.random()-1,r=t*t+e*e;return 0==r||r>1?a():t*Math.sqrt(-2*Math.log(r)/r)}e.exports=r.default}(v,v.exports);var m={exports:{}};!function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function(t,e){var r=t.shape[0],i=(0,n.default)(new Float64Array(r*r),[r,r]);switch(e){case"euclidean":for(var a=0;a<r;a++)for(var s=a+1;s<r;s++){var d=o(t.pick(a,null),t.pick(s,null));i.set(a,s,d),i.set(s,a,d)}break;case"manhattan":for(a=0;a<r;a++)for(s=a+1;s<r;s++){d=u(t.pick(a,null),t.pick(s,null));i.set(a,s,d),i.set(s,a,d)}break;case"jaccard":for(a=0;a<r;a++)for(s=a+1;s<r;s++){d=l(t.pick(a,null),t.pick(s,null));i.set(a,s,d),i.set(s,a,d)}break;case"dice":for(a=0;a<r;a++)for(s=a+1;s<r;s++){d=f(t.pick(a,null),t.pick(s,null));i.set(a,s,d),i.set(s,a,d)}}return i};var n=s(t),a=s(i);function s(t){return t&&t.__esModule?t:{default:t}}var o=(0,a.default)({args:["array","array"],pre:function(t,e){this.sum=0},body:function(t,e){var r=t-e;this.sum+=r*r},post:function(t,e){return Math.sqrt(this.sum)}}),u=(0,a.default)({args:["array","array"],pre:function(t,e){this.sum=0},body:function(t,e){this.sum+=Math.abs(t-e)},post:function(t,e){return this.sum}}),l=(0,a.default)({args:["array","array"],pre:function(t,e){this.tf=0,this.tt=0},body:function(t,e){var r=Math.round(t),n=Math.round(e);this.tf+=+(r!=n),this.tt+=+(1==r&&1==n)},post:function(t,e){return this.tf+this.tt===0?1:this.tf/(this.tf+this.tt)}}),f=(0,a.default)({args:["array","array"],pre:function(t,e){this.tf=0,this.tt=0},body:function(t,e){var r=Math.round(t),n=Math.round(e);this.tf+=+(r!=n),this.tt+=+(1==r&&1==n)},post:function(t,e){return this.tf+this.tt===0?1:this.tf/(this.tf+2*this.tt)}});e.exports=r.default}(m,m.exports);var y={exports:{}};!function(r,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(t,e){for(var r=t.shape[0],n=(0,i.default)(new Float64Array(r*r),[r,r]),s=(0,i.default)(new Float64Array(r*r),[r,r]),f=void 0,d=void 0,h=1/0,p=Math.log(e),c=void 0,v=void 0,m=void 0,y=0;y<r;y++){f=1,d=-1/0,h=1/0;for(var g=0;g<100;g++){for(var b=0;b<r;b++)n.set(y,b,Math.exp(-t.get(y,b)*f));n.set(y,y,0),v=0;for(b=0;b<r;b++)v+=n.get(y,b);0==v&&(v=o),m=0;for(b=0;b<r;b++)n.set(y,b,n.get(y,b)/v),m+=t.get(y,b)*n.get(y,b);if(c=Math.log(v)+f*m-p,Math.abs(c)<=l)break;c>0?(d=f,h==1/0?f*=2:f=(f+h)/2):(h=f,d==-1/0?f/=2:f=(f+d)/2)}}a.default.add(s,n,n.transpose(1,0));var w=Math.max(a.default.sum(s),u);return a.default.divseq(s,w),a.default.maxseq(s,u),s};var i=s(t),a=s(e);function s(t){return t&&t.__esModule?t:{default:t}}var o=1e-7,u=Number.EPSILON||2220446049250313e-31,l=1e-5;r.exports=n.default}(y,y.exports);var g={exports:{}};!function(r,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(t,e,r){var n=t.shape[0],i=t.shape[1],o=(0,a.default)(new Float64Array(n*n),[n,n]),l=(0,u.default)(t,"euclidean");d(l);var h=(r+1)/-2;s.default.powseq(s.default.divseq(s.default.addseq(l,1),r),h);for(var p=0;p<n;p++)l.set(p,p,0);var c=Math.max(s.default.sum(l),f);s.default.divs(o,l,c),s.default.maxseq(o,f);var v=(0,a.default)(new Float64Array(n*n),[n,n]),m=(0,a.default)(new Float64Array(n*n),[n,n]);s.default.div(v,e,o),s.default.logeq(v),s.default.assign(m,e);var y=s.default.sum(s.default.muleq(v,m)),g=(0,a.default)(new Float64Array(t.size),t.shape),b=(0,a.default)(new Float64Array(n*n),[n,n]);s.default.sub(b,e,o),s.default.muleq(b,l);for(p=0;p<n;p++)for(var w=0;w<i;w++){var _=(0,a.default)(new Float64Array(t.shape[0]),[t.shape[0]]);s.default.assign(_,t.pick(null,w)),s.default.addseq(s.default.negeq(_),t.get(p,w)),s.default.muleq(_,b.pick(p,null)),g.set(p,w,s.default.sum(_))}var x=2*(r+1)/r;return s.default.mulseq(g,x),[y,g]};var a=l(t),s=l(e),o=l(i),u=l(m.exports);function l(t){return t&&t.__esModule?t:{default:t}}var f=Number.EPSILON||2220446049250313e-31,d=(0,o.default)({args:["array"],body:function(t){}});r.exports=n.default}(g,g.exports),function(a,s){Object.defineProperty(s,"__esModule",{value:!0});var o=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=t[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!e||r.length!==e);n=!0);}catch(t){i=!0,a=t}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),l=c,f=M(t),d=M(e),h=M(r),p=M(n),b=M(i),w=M(v.exports),_=M(m.exports),x=M(y.exports),E=M(g.exports);function M(t){return t&&t.__esModule?t:{default:t}}function L(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}var k=function(t){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var r=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,Object.getPrototypeOf(e).call(this));return t=t||{},r.dim=t.dim||2,r.perplexity=t.perplexity||30,r.earlyExaggeration=t.earlyExaggeration||4,r.learningRate=t.learningRate||1e3,r.nIter=t.nIter||1e3,r.metric=t.metric||"euclidean",r.barneshut=t.barneshut||!1,r.inputData=null,r.outputEmbedding=null,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,t),u(e,[{key:"init",value:function(t){var e=(t=t||{}).data||[],r=t.type||"dense";if("dense"===r)this.inputData=(0,h.default)(e);else{if("sparse"!==r)throw new Error("input data type must be dense or sparse");for(var n=[],i=1,a=function(t){var r=Math.max.apply(null,e.map((function(e){return e[t]})))+1;n.push(r),i*=r},s=0;s<e[0].length;s++)a(s);this.inputData=(0,f.default)(new Float64Array(i),n);var o=!0,u=!1,l=void 0;try{for(var d,p=e[Symbol.iterator]();!(o=(d=p.next()).done);o=!0){var c,v=d.value;(c=this.inputData).set.apply(c,L(v).concat([1]))}}catch(t){u=!0,l=t}finally{try{!o&&p.return&&p.return()}finally{if(u)throw l}}}this.outputEmbedding=(0,w.default)(this.inputData.shape[0],this.dim)}},{key:"run",value:function(){this.emit("progressStatus","Calculating pairwise distances"),this.distances=(0,_.default)(this.inputData,this.metric),this.emit("progressStatus","Calculating joint probabilities"),this.alpha=Math.max(this.dim-1,1),this.P=(0,x.default)(this.distances,this.perplexity);var t=Number.MAX_VALUE,e=0;this.emit("progressStatus","Early exaggeration with momentum 0.5"),d.default.mulseq(this.P,this.earlyExaggeration);var r=this._gradDesc(e,50,.5,0,0),n=o(r,2);n[0],e=n[1],this.emit("progressStatus","Early exaggeration with momentum 0.8");var i=this._gradDesc(e+1,100,.8,0,0),a=o(i,2);a[0],e=a[1],this.emit("progressStatus","Final optimization with momentum 0.8"),d.default.divseq(this.P,this.earlyExaggeration);var s=this._gradDesc(e+1,this.nIter,.8,1e-6,1e-6),u=o(s,2);return t=u[0],e=u[1],this.emit("progressStatus","Optimization end"),[t,e]}},{key:"rerun",value:function(){this.outputEmbedding=(0,w.default)(this.inputData.shape[0],this.dim);var t=this.run(),e=o(t,2);return[e[0],e[1]]}},{key:"getOutput",value:function(){return(0,p.default)(this.outputEmbedding)}},{key:"getOutputScaled",value:function(){for(var t=(0,f.default)(new Float64Array(this.outputEmbedding.size),this.outputEmbedding.shape),e=(0,f.default)(new Float64Array(this.outputEmbedding.shape[0]),[this.outputEmbedding.shape[0]]),r=0;r<this.outputEmbedding.shape[1];r++){var n=d.default.sup(d.default.abs(e,this.outputEmbedding.pick(null,r)));d.default.divs(t.pick(null,r),this.outputEmbedding.pick(null,r),n)}return(0,p.default)(t)}},{key:"_gradDesc",value:function(t,e,r){for(var n=arguments.length<=3||void 0===arguments[3]?1e-6:arguments[3],i=arguments.length<=4||void 0===arguments[4]?1e-6:arguments[4],a=(0,f.default)(new Float64Array(this.outputEmbedding.size),this.outputEmbedding.shape),s=new Float64Array(this.outputEmbedding.size),u=0;u<s.length;u++)s[u]=1;var l=(0,f.default)(s,this.outputEmbedding.shape),h=Number.MAX_VALUE,p=Number.MAX_VALUE,c=0,v=(0,b.default)({args:["array"],pre:function(t){this.sum=0},body:function(t){this.sum+=t*t},post:function(t){return Math.sqrt(this.sum)}}),m=(0,b.default)({args:["array","array","array"],body:function(t,e,r){}}),y=void 0;for(y=t;y<e;y++){var g=(0,E.default)(this.outputEmbedding,this.P,this.alpha),w=o(g,2),_=w[0],x=w[1],M=Math.abs(_-h);h=_;var L=v(x);if(this.emit("progressIter",[y,h,L]),h<p)p=h,c=y;else if(y-c>30)break;if(n>=L)break;if(i>=M)break;m(l,a,x),d.default.muleq(x,l);var k=(0,f.default)(new Float64Array(x.size),x.shape);d.default.muls(k,x,this.learningRate),d.default.mulseq(a,r),d.default.subeq(a,k),d.default.addeq(this.outputEmbedding,a),this.emit("progressData",this.getOutputScaled())}return[h,y]}}]),e}(l.EventEmitter);s.default=k,a.exports=s.default}(s,s.exports);var b=s.exports,w=s.exports.__esModule;export{w as __esModule,b as default};
