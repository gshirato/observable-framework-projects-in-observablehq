/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/umap-js@1.3.3/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import t from"../ml-levenberg-marquardt@2.1.1/_esm.js";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r={},n={},i={},o={},a=e&&e.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}};function s(t,e){return Math.floor(e()*t)}function h(t){for(var e=[],r=0;r<t;r++)e.push(void 0);return e}function u(t,e){return h(t).map((function(){return e}))}function l(t){return u(t,0)}function c(t){return t.reduce((function(t,e){return t+e}))}Object.defineProperty(o,"__esModule",{value:!0}),o.tauRandInt=s,o.tauRand=function(t){return t()},o.norm=function(t){var e,r,n=0;try{for(var i=a(t),o=i.next();!o.done;o=i.next()){var s=o.value;n+=Math.pow(s,2)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return Math.sqrt(n)},o.empty=h,o.range=function(t){return h(t).map((function(t,e){return e}))},o.filled=u,o.zeros=l,o.ones=function(t){return u(t,1)},o.linear=function(t,e,r){return h(r).map((function(n,i){return t+i*((e-t)/(r-1))}))},o.sum=c,o.mean=function(t){return c(t)/t.length},o.max=function(t){for(var e=0,r=0;r<t.length;r++)e=t[r]>e?t[r]:e;return e},o.max2d=function(t){for(var e=0,r=0;r<t.length;r++)for(var n=0;n<t[r].length;n++)e=t[r][n]>e?t[r][n]:e;return e},o.rejectionSample=function(t,e,r){for(var n=l(t),i=0;i<t;i++)for(var o=!0;o;){for(var a=s(e,r),h=!1,u=0;u<i;u++)if(a===n[u]){h=!0;break}h||(o=!1),n[i]=a}return n},o.reshape2d=function(t,e,r){var n=[],i=0;if(t.length!==e*r)throw new Error("Array dimensions must match input length.");for(var o=0;o<e;o++){for(var a=[],s=0;s<r;s++)a.push(t[i]),i+=1;n.push(a)}return n};var f=e&&e.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e};Object.defineProperty(i,"__esModule",{value:!0});var p=f(o);function v(t,e){var r=function(r){return p.empty(t).map((function(){return p.filled(e,r)}))},n=[];return n.push(r(-1)),n.push(r(1/0)),n.push(r(0)),n}function d(t,e,r,n,i){e=Math.floor(e);var o=t[0][e],a=t[1][e];if(t[2][e],r>=a[0])return 0;for(var s=0;s<o.length;s++)if(n===o[s])return 0;return m(t,e,r,n,i)}function m(t,e,r,n,i){var o=t[0][e],a=t[1][e],s=t[2][e];if(r>=a[0])return 0;a[0]=r,o[0]=n,s[0]=i;for(var h=0,u=0;;){var l=2*h+1,c=l+1,f=t[0][0].length;if(l>=f)break;if(c>=f){if(!(a[l]>r))break;u=l}else if(a[l]>=a[c]){if(!(r<a[l]))break;u=l}else{if(!(r<a[c]))break;u=c}a[h]=a[u],o[h]=o[u],s[h]=s[u],h=u}return a[h]=r,o[h]=n,s[h]=i,1}function g(t,e,r,n){for(;2*n+1<r;){var i=2*n+1,o=i+1,a=n;if(t[a]<t[i]&&(a=i),o<r&&t[a]<t[o]&&(a=o),a===n)break;var s=t[n];t[n]=t[a],t[a]=s;var h=e[n];e[n]=e[a],e[a]=h,n=a}}i.makeHeap=v,i.rejectionSample=function(t,e,r){for(var n=p.zeros(t),i=0;i<t;i++){for(var o=!0,a=0;o;){a=p.tauRandInt(e,r);for(var s=!1,h=0;h<i;h++)if(a===n[h]){s=!0;break}s||(o=!1)}n[i]=a}return n},i.heapPush=d,i.uncheckedHeapPush=m,i.buildCandidates=function(t,e,r,n,i){for(var o=v(e,n),a=0;a<e;a++)for(var s=0;s<r;s++)if(!(t[0][a][s]<0)){var h=t[0][a][s],u=t[2][a][s],l=p.tauRand(i);d(o,a,l,h,u),d(o,h,l,a,u),t[2][a][s]=0}return o},i.deheapSort=function(t){for(var e=t[0],r=t[1],n=0;n<e.length;n++)for(var i=e[n],o=r[n],a=0;a<i.length-1;a++){var s=i.length-a-1,h=o.length-a-1,u=i[0];i[0]=i[s],i[s]=u;var l=o[0];o[0]=o[h],o[h]=l,g(o,i,h,0)}return{indices:e,weights:r}},i.smallestFlagged=function(t,e){for(var r=t[0][e],n=t[1][e],i=t[2][e],o=1/0,a=-1,s=0;s>r.length;s++)1===i[s]&&n[s]<o&&(o=n[s],a=s);return a>=0?(i[a]=0,Math.floor(r[a])):-1};var y,S={},b=e&&e.__read||function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},w=e&&e.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}},M=e&&e.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e};Object.defineProperty(S,"__esModule",{value:!0});var z=M(o),N=function(){function t(t,e,r,n){if(this.entries=new Map,this.nRows=0,this.nCols=0,t.length!==e.length||t.length!==r.length)throw new Error("rows, cols and values arrays must all have the same length");this.nRows=n[0],this.nCols=n[1];for(var i=0;i<r.length;i++){var o=t[i],a=e[i];this.checkDims(o,a);var s=this.makeKey(o,a);this.entries.set(s,{value:r[i],row:o,col:a})}}return t.prototype.makeKey=function(t,e){return t+":"+e},t.prototype.checkDims=function(t,e){if(!(t<this.nRows&&e<this.nCols))throw new Error("row and/or col specified outside of matrix dimensions")},t.prototype.set=function(t,e,r){this.checkDims(t,e);var n=this.makeKey(t,e);this.entries.has(n)?this.entries.get(n).value=r:this.entries.set(n,{value:r,row:t,col:e})},t.prototype.get=function(t,e,r){void 0===r&&(r=0),this.checkDims(t,e);var n=this.makeKey(t,e);return this.entries.has(n)?this.entries.get(n).value:r},t.prototype.getAll=function(t){void 0===t&&(t=!0);var e=[];return this.entries.forEach((function(t){e.push(t)})),t&&e.sort((function(t,e){return t.row===e.row?t.col-e.col:t.row-e.row})),e},t.prototype.getDims=function(){return[this.nRows,this.nCols]},t.prototype.getRows=function(){return Array.from(this.entries,(function(t){var e=b(t,2);return e[0],e[1].row}))},t.prototype.getCols=function(){return Array.from(this.entries,(function(t){var e=b(t,2);return e[0],e[1].col}))},t.prototype.getValues=function(){return Array.from(this.entries,(function(t){var e=b(t,2);return e[0],e[1].value}))},t.prototype.forEach=function(t){this.entries.forEach((function(e){return t(e.value,e.row,e.col)}))},t.prototype.map=function(e){var r=[];this.entries.forEach((function(t){r.push(e(t.value,t.row,t.col))}));var n=[this.nRows,this.nCols];return new t(this.getRows(),this.getCols(),r,n)},t.prototype.toArray=function(){var t=this,e=z.empty(this.nRows).map((function(){return z.zeros(t.nCols)}));return this.entries.forEach((function(t){e[t.row][t.col]=t.value})),e},t}();S.SparseMatrix=N,S.transpose=function(t){var e=[],r=[],n=[];t.forEach((function(t,i,o){e.push(i),r.push(o),n.push(t)}));var i=[t.nCols,t.nRows];return new N(r,e,n,i)},S.identity=function(t){for(var e=b(t,1)[0],r=new N([],[],[],t),n=0;n<e;n++)r.set(n,n,1);return r},S.pairwiseMultiply=function(t,e){return k(t,e,(function(t,e){return t*e}))},S.add=function(t,e){return k(t,e,(function(t,e){return t+e}))},S.subtract=function(t,e){return k(t,e,(function(t,e){return t-e}))},S.maximum=function(t,e){return k(t,e,(function(t,e){return t>e?t:e}))},S.multiplyScalar=function(t,e){return t.map((function(t){return t*e}))},S.eliminateZeros=function(t){for(var e=new Set,r=t.getValues(),n=t.getRows(),i=t.getCols(),o=0;o<r.length;o++)0===r[o]&&e.add(o);var a=function(t,r){return!e.has(r)},s=r.filter(a),h=n.filter(a),u=i.filter(a);return new N(h,u,s,t.getDims())},S.normalize=function(t,e){var r,n;void 0===e&&(e="l2");var i=_[e],o=new Map;t.forEach((function(t,e,r){var n=o.get(e)||[];n.push(r),o.set(e,n)}));var a=new N([],[],[],t.getDims()),s=function(e){for(var r=o.get(e).sort(),n=r.map((function(r){return t.get(e,r)})),s=i(n),h=0;h<s.length;h++)a.set(e,r[h],s[h])};try{for(var h=w(o.keys()),u=h.next();!u.done;u=h.next()){s(u.value)}}catch(t){r={error:t}}finally{try{u&&!u.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}return a};var _=((y={}).max=function(t){for(var e=-1/0,r=0;r<t.length;r++)e=t[r]>e?t[r]:e;return t.map((function(t){return t/e}))},y.l1=function(t){for(var e=0,r=0;r<t.length;r++)e+=t[r];return t.map((function(t){return t/e}))},y.l2=function(t){for(var e=0,r=0;r<t.length;r++)e+=Math.pow(t[r],2);return t.map((function(t){return Math.sqrt(Math.pow(t,2)/e)}))},y);function k(t,e,r){for(var n=new Set,i=[],o=[],a=[],s=function(n,s){i.push(n),o.push(s);var h=r(t.get(n,s),e.get(n,s));a.push(h)},h=t.getValues(),u=t.getRows(),l=t.getCols(),c=0;c<h.length;c++){var f=(m=u[c])+":"+(g=l[c]);n.add(f),s(m,g)}var p=e.getValues(),v=e.getRows(),d=e.getCols();for(c=0;c<p.length;c++){var m,g;f=(m=v[c])+":"+(g=d[c]);n.has(f)||s(m,g)}var y=[t.nRows,t.nCols];return new N(i,o,a,y)}S.getCSR=function(t){var e=[];t.forEach((function(t,r,n){e.push({value:t,row:r,col:n})})),e.sort((function(t,e){return t.row===e.row?t.col-e.col:t.row-e.row}));for(var r=[],n=[],i=[],o=-1,a=0;a<e.length;a++){var s=e[a],h=s.row,u=s.col,l=s.value;h!==o&&(o=h,i.push(a)),r.push(u),n.push(l)}return{indices:r,values:n,indptr:i}};var E={},x={},P=e&&e.__read||function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},R=e&&e.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(P(arguments[e]));return t},O=e&&e.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}},C=e&&e.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e};Object.defineProperty(x,"__esModule",{value:!0});var F=C(o),D=function(t,e,r,n){this.hyperplanes=t,this.offsets=e,this.children=r,this.indices=n};function I(t,e,r,n,i){if(void 0===r&&(r=30),e.length>r){var o=function(t,e,r){var n=t[0].length,i=F.tauRandInt(e.length,r),o=F.tauRandInt(e.length,r);o=(o+=i===o?1:0)%e.length;for(var a=e[i],s=e[o],h=0,u=F.zeros(n),l=0;l<u.length;l++)u[l]=t[a][l]-t[s][l],h-=u[l]*(t[a][l]+t[s][l])/2;var c=0,f=0,p=F.zeros(e.length);for(l=0;l<e.length;l++){for(var v=h,d=0;d<n;d++)v+=u[d]*t[e[l]][d];0===v?(p[l]=F.tauRandInt(2,r),0===p[l]?c+=1:f+=1):v>0?(p[l]=0,c+=1):(p[l]=1,f+=1)}var m=F.zeros(c),g=F.zeros(f);c=0,f=0;for(l=0;l<p.length;l++)0===p[l]?(m[c]=e[l],c+=1):(g[f]=e[l],f+=1);return{indicesLeft:m,indicesRight:g,hyperplane:u,offset:h}}(t,e,i),a=o.indicesLeft,s=o.indicesRight,h=o.hyperplane,u=o.offset;return{leftChild:I(t,a,r,n+1,i),rightChild:I(t,s,r,n+1,i),isLeaf:!1,hyperplane:h,offset:u}}return{indices:e,isLeaf:!0}}function L(t,e,r,n,i,o,a){var s;if(t.isLeaf)return n[o][0]=-a,(s=i[a]).splice.apply(s,R([0,t.indices.length],t.indices)),{nodeNum:o,leafNum:a+=1};e[o]=t.hyperplane,r[o]=t.offset,n[o][0]=o+1;var h=o,u=L(t.leftChild,e,r,n,i,o+1,a);return o=u.nodeNum,a=u.leafNum,n[h][1]=o+1,{nodeNum:(u=L(t.rightChild,e,r,n,i,o+1,a)).nodeNum,leafNum:u.leafNum}}function j(t){return t.isLeaf?1:1+j(t.leftChild)+j(t.rightChild)}function A(t){return t.isLeaf?1:A(t.leftChild)+A(t.rightChild)}function T(t,e,r,n){for(var i=e,o=0;o<r.length;o++)i+=t[o]*r[o];return 0===i?F.tauRandInt(2,n):i>0?0:1}x.FlatTree=D,x.makeForest=function(t,e,r,n){var i=Math.max(10,e),o=F.range(r).map((function(e,r){return function(t,e,r,n){void 0===e&&(e=30);var i=F.range(t.length),o=I(t,i,e,r,n);return o}(t,i,r,n)})),a=o.map((function(t){return function(t,e){var r=j(t),n=A(t),i=F.range(r).map((function(){return F.zeros(t.hyperplane?t.hyperplane.length:0)})),o=F.zeros(r),a=F.range(r).map((function(){return[-1,-1]})),s=F.range(n).map((function(){return F.range(e).map((function(){return-1}))}));return L(t,i,o,a,s,0,0),new D(i,o,a,s)}(t,i)}));return a},x.makeLeafArray=function(t){var e,r;if(t.length>0){var n=[];try{for(var i=O(t),o=i.next();!o.done;o=i.next()){var a=o.value;n.push.apply(n,R(a.indices))}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n}return[[-1]]},x.searchFlatTree=function(t,e,r){for(var n=0;e.children[n][0]>0;){n=0===T(e.hyperplanes[n],e.offsets[n],t,r)?e.children[n][0]:e.children[n][1]}var i=-1*e.children[n][0];return e.indices[i]};var V=e&&e.__values||function(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}},K=e&&e.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e};Object.defineProperty(E,"__esModule",{value:!0});var G=K(i),q=K(S),W=K(x),H=K(o);E.makeNNDescent=function(t,e){return function(r,n,i,o,a,s,h,u){void 0===o&&(o=10),void 0===a&&(a=50),void 0===s&&(s=.001),void 0===h&&(h=.5),void 0===u&&(u=!0);for(var l=r.length,c=G.makeHeap(r.length,i),f=0;f<r.length;f++)for(var p=G.rejectionSample(i,r.length,e),v=0;v<p.length;v++){var d=t(r[f],r[p[v]]);G.heapPush(c,f,d,p[v],1),G.heapPush(c,p[v],d,f,1)}if(u)for(var m=0;m<n.length;m++)for(f=0;f<n[m].length&&!(n[m][f]<0);f++)for(v=f+1;v<n[m].length&&!(n[m][v]<0);v++){d=t(r[n[m][f]],r[n[m][v]]);G.heapPush(c,n[m][f],d,n[m][v],1),G.heapPush(c,n[m][v],d,n[m][f],1)}for(m=0;m<o;m++){var g=G.buildCandidates(c,l,i,a,e),y=0;for(f=0;f<l;f++)for(v=0;v<a;v++){var S=Math.floor(g[0][f][v]);if(!(S<0||H.tauRand(e)<h))for(var b=0;b<a;b++){var w=Math.floor(g[0][f][b]),M=g[2][f][v],z=g[2][f][b];if(!(w<0||!M&&!z)){d=t(r[S],r[w]);y+=G.heapPush(c,S,d,w,1),y+=G.heapPush(c,w,d,S,1)}}}if(y<=s*i*r.length)break}return G.deheapSort(c)}},E.makeInitializations=function(t){return{initFromRandom:function(e,r,n,i,o){for(var a=0;a<n.length;a++)for(var s=H.rejectionSample(e,r.length,o),h=0;h<s.length;h++)if(!(s[h]<0)){var u=t(r[s[h]],n[a]);G.heapPush(i,a,u,s[h],1)}},initFromTree:function(e,r,n,i,o){for(var a=0;a<n.length;a++)for(var s=W.searchFlatTree(n[a],e,o),h=0;h<s.length;h++){if(s[h]<0)return;var u=t(r[s[h]],n[a]);G.heapPush(i,a,u,s[h],1)}}}},E.makeInitializedNNSearch=function(t){return function(e,r,n,i){for(var o,a,s=q.getCSR(r),h=s.indices,u=s.indptr,l=0;l<i.length;l++)for(var c=new Set(n[0][l]);;){var f=G.smallestFlagged(n,l);if(-1===f)break;var p=h.slice(u[f],u[f+1]);try{for(var v=V(p),d=v.next();!d.done;d=v.next()){var m=d.value;if(m!==f&&-1!==m&&!c.has(m)){var g=t(e[m],i[l]);G.uncheckedHeapPush(n,l,g,m,1),c.add(m)}}}catch(t){o={error:t}}finally{try{d&&!d.done&&(a=v.return)&&a.call(v)}finally{if(o)throw o.error}}}return n}},E.initializeSearch=function(t,e,r,n,i,o,a){var s,h,u=G.makeHeap(r.length,n);if(i(n,e,r,u,a),t)try{for(var l=V(t),c=l.next();!c.done;c=l.next()){o(c.value,e,r,u,a)}}catch(t){s={error:t}}finally{try{c&&!c.done&&(h=l.return)&&h.call(l)}finally{if(s)throw s.error}}return u};var X=e&&e.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,o){function a(t){try{h(n.next(t))}catch(t){o(t)}}function s(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){t.done?i(t.value):new r((function(e){e(t.value)})).then(a,s)}h((n=n.apply(t,e||[])).next())}))},Z=e&&e.__generator||function(t,e){var r,n,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},Q=e&&e.__read||function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a},U=e&&e.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(Q(arguments[e]));return t},Y=e&&e.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e},B=e&&e.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});var J=Y(i),$=Y(S),tt=Y(E),et=Y(x),rt=Y(o),nt=B(t),it=1e-5,ot=.001,at=function(){function t(t){void 0===t&&(t={});var e=this;this.learningRate=1,this.localConnectivity=1,this.minDist=.1,this.nComponents=2,this.nEpochs=0,this.nNeighbors=15,this.negativeSampleRate=5,this.random=Math.random,this.repulsionStrength=1,this.setOpMixRatio=1,this.spread=1,this.transformQueueSize=4,this.targetMetric="categorical",this.targetWeight=.5,this.targetNNeighbors=this.nNeighbors,this.distanceFn=st,this.isInitialized=!1,this.rpForest=[],this.embedding=[],this.optimizationState=new ht;var r=function(r){void 0!==t[r]&&(e[r]=t[r])};r("distanceFn"),r("learningRate"),r("localConnectivity"),r("minDist"),r("nComponents"),r("nEpochs"),r("nNeighbors"),r("negativeSampleRate"),r("random"),r("repulsionStrength"),r("setOpMixRatio"),r("spread"),r("transformQueueSize")}return t.prototype.fit=function(t){return this.initializeFit(t),this.optimizeLayout(),this.embedding},t.prototype.fitAsync=function(t,e){return void 0===e&&(e=function(){return!0}),X(this,void 0,void 0,(function(){return Z(this,(function(r){switch(r.label){case 0:return this.initializeFit(t),[4,this.optimizeLayoutAsync(e)];case 1:return r.sent(),[2,this.embedding]}}))}))},t.prototype.setSupervisedProjection=function(t,e){void 0===e&&(e={}),this.Y=t,this.targetMetric=e.targetMetric||this.targetMetric,this.targetWeight=e.targetWeight||this.targetWeight,this.targetNNeighbors=e.targetNNeighbors||this.targetNNeighbors},t.prototype.setPrecomputedKNN=function(t,e){this.knnIndices=t,this.knnDistances=e},t.prototype.initializeFit=function(t){if(t.length<=this.nNeighbors)throw new Error("Not enough data points ("+t.length+") to create nNeighbors: "+this.nNeighbors+".  Add more data points or adjust the configuration.");if(this.X===t&&this.isInitialized)return this.getNEpochs();if(this.X=t,!this.knnIndices&&!this.knnDistances){var e=this.nearestNeighbors(t);this.knnIndices=e.knnIndices,this.knnDistances=e.knnDistances}this.graph=this.fuzzySimplicialSet(t,this.nNeighbors,this.setOpMixRatio),this.makeSearchFns(),this.searchGraph=this.makeSearchGraph(t),this.processGraphForSupervisedProjection();var r=this.initializeSimplicialSetEmbedding(),n=r.head,i=r.tail,o=r.epochsPerSample;return this.optimizationState.head=n,this.optimizationState.tail=i,this.optimizationState.epochsPerSample=o,this.initializeOptimization(),this.prepareForOptimizationLoop(),this.isInitialized=!0,this.getNEpochs()},t.prototype.makeSearchFns=function(){var t=tt.makeInitializations(this.distanceFn),e=t.initFromTree,r=t.initFromRandom;this.initFromTree=e,this.initFromRandom=r,this.search=tt.makeInitializedNNSearch(this.distanceFn)},t.prototype.makeSearchGraph=function(t){for(var e=this.knnIndices,r=this.knnDistances,n=[t.length,t.length],i=new $.SparseMatrix([],[],[],n),o=0;o<e.length;o++)for(var a=e[o],s=r[o],h=0;h<a.length;h++){var u=a[h],l=s[h];l>0&&i.set(o,u,l)}var c=$.transpose(i);return $.maximum(i,c)},t.prototype.transform=function(t){var e=this,r=this.X;if(void 0===r||0===r.length)throw new Error("No data has been fit.");var n=Math.floor(this.nNeighbors*this.transformQueueSize);n=Math.min(r.length,n);var i=tt.initializeSearch(this.rpForest,r,t,n,this.initFromRandom,this.initFromTree,this.random),o=this.search(r,this.searchGraph,i,t),a=J.deheapSort(o),s=a.indices,h=a.weights;s=s.map((function(t){return t.slice(0,e.nNeighbors)})),h=h.map((function(t){return t.slice(0,e.nNeighbors)}));var u=Math.max(0,this.localConnectivity-1),l=this.smoothKNNDistance(h,this.nNeighbors,u),c=l.sigmas,f=l.rhos,p=this.computeMembershipStrengths(s,h,c,f),v=p.rows,d=p.cols,m=p.vals,g=[t.length,r.length],y=new $.SparseMatrix(v,d,m,g),S=$.normalize(y,"l1"),b=$.getCSR(S),w=t.length,M=vt(rt.reshape2d(b.indices,w,this.nNeighbors),rt.reshape2d(b.values,w,this.nNeighbors),this.embedding),z=this.nEpochs?this.nEpochs/3:y.nRows<=1e4?100:30,N=y.getValues().reduce((function(t,e){return e>t?e:t}),0);y=y.map((function(t){return t<N/z?0:t})),y=$.eliminateZeros(y);var _=this.makeEpochsPerSample(y.getValues(),z),k=y.getRows(),E=y.getCols();return this.assignOptimizationStateParameters({headEmbedding:M,tailEmbedding:this.embedding,head:k,tail:E,currentEpoch:0,nEpochs:z,nVertices:y.getDims()[1],epochsPerSample:_}),this.prepareForOptimizationLoop(),this.optimizeLayout()},t.prototype.processGraphForSupervisedProjection=function(){var t=this.Y,e=this.X;if(t){if(t.length!==e.length)throw new Error("Length of X and y must be equal");if("categorical"===this.targetMetric){var r=this.targetWeight<1?1/(1-this.targetWeight)*2.5:1e12;this.graph=this.categoricalSimplicialSetIntersection(this.graph,t,r)}}},t.prototype.step=function(){var t=this.optimizationState.currentEpoch;return t<this.getNEpochs()&&this.optimizeLayoutStep(t),this.optimizationState.currentEpoch},t.prototype.getEmbedding=function(){return this.embedding},t.prototype.nearestNeighbors=function(t){var e,r=this.distanceFn,n=this.nNeighbors,i=tt.makeNNDescent(r,this.random),o=5+Math.floor(.5===(e=Math.pow(t.length,.5)/20)?0:Math.round(e)),a=Math.max(5,Math.floor(Math.round(function(t){return Math.log(t)/Math.log(2)}(t.length))));this.rpForest=et.makeForest(t,n,o,this.random);var s=i(t,et.makeLeafArray(this.rpForest),n,a);return{knnIndices:s.indices,knnDistances:s.weights}},t.prototype.fuzzySimplicialSet=function(t,e,r){void 0===r&&(r=1);var n=this,i=n.knnIndices,o=void 0===i?[]:i,a=n.knnDistances,s=void 0===a?[]:a,h=n.localConnectivity,u=this.smoothKNNDistance(s,e,h),l=u.sigmas,c=u.rhos,f=this.computeMembershipStrengths(o,s,l,c),p=f.rows,v=f.cols,d=f.vals,m=[t.length,t.length],g=new $.SparseMatrix(p,v,d,m),y=$.transpose(g),S=$.pairwiseMultiply(g,y),b=$.subtract($.add(g,y),S),w=$.multiplyScalar(b,r),M=$.multiplyScalar(S,1-r);return $.add(w,M)},t.prototype.categoricalSimplicialSetIntersection=function(t,e,r,n){void 0===n&&(n=1);var i=ft(t,e,n,r);return pt(i=$.eliminateZeros(i))},t.prototype.smoothKNNDistance=function(t,e,r,n,i){void 0===r&&(r=1),void 0===n&&(n=64),void 0===i&&(i=1);for(var o=Math.log(e)/Math.log(2)*i,a=rt.zeros(t.length),s=rt.zeros(t.length),h=0;h<t.length;h++){var u=0,l=1/0,c=1,f=t[h],p=f.filter((function(t){return t>0}));if(p.length>=r){var v=Math.floor(r),d=r-v;v>0?(a[h]=p[v-1],d>it&&(a[h]+=d*(p[v]-p[v-1]))):a[h]=d*p[0]}else p.length>0&&(a[h]=rt.max(p));for(var m=0;m<n;m++){for(var g=0,y=1;y<t[h].length;y++){var S=t[h][y]-a[h];g+=S>0?Math.exp(-S/c):1}if(Math.abs(g-o)<it)break;g>o?c=(u+(l=c))/2:(u=c,l===1/0?c*=2:c=(u+l)/2)}if(s[h]=c,a[h]>0){var b=rt.mean(f);s[h]<ot*b&&(s[h]=ot*b)}else{var w=rt.mean(t.map(rt.mean));s[h]<ot*w&&(s[h]=ot*w)}}return{sigmas:s,rhos:a}},t.prototype.computeMembershipStrengths=function(t,e,r,n){for(var i=t.length,o=t[0].length,a=rt.zeros(i*o),s=rt.zeros(i*o),h=rt.zeros(i*o),u=0;u<i;u++)for(var l=0;l<o;l++){var c=0;-1!==t[u][l]&&(c=t[u][l]===u?0:e[u][l]-n[u]<=0?1:Math.exp(-(e[u][l]-n[u])/r[u]),a[u*o+l]=u,s[u*o+l]=t[u][l],h[u*o+l]=c)}return{rows:a,cols:s,vals:h}},t.prototype.initializeSimplicialSetEmbedding=function(){for(var t=this,e=this.getNEpochs(),r=this.nComponents,n=this.graph.getValues(),i=0,o=0;o<n.length;o++){var a=n[o];i<n[o]&&(i=a)}var s=this.graph.map((function(t){return t<i/e?0:t}));this.embedding=rt.zeros(s.nRows).map((function(){return rt.zeros(r).map((function(){return 20*rt.tauRand(t.random)-10}))}));var h=[],u=[],l=[],c=s.getAll();for(o=0;o<c.length;o++){var f=c[o];f.value&&(h.push(f.value),l.push(f.row),u.push(f.col))}return{head:u,tail:l,epochsPerSample:this.makeEpochsPerSample(h,e)}},t.prototype.makeEpochsPerSample=function(t,e){var r=rt.filled(t.length,-1),n=rt.max(t),i=t.map((function(t){return t/n*e}));return i.forEach((function(t,n){t>0&&(r[n]=e/i[n])})),r},t.prototype.assignOptimizationStateParameters=function(t){Object.assign(this.optimizationState,t)},t.prototype.prepareForOptimizationLoop=function(){var t=this,e=t.repulsionStrength,r=t.learningRate,n=t.negativeSampleRate,i=this.optimizationState,o=i.epochsPerSample,a=i.headEmbedding,s=i.tailEmbedding,h=a[0].length,u=a.length===s.length,l=o.map((function(t){return t/n})),c=U(l),f=U(o);this.assignOptimizationStateParameters({epochOfNextSample:f,epochOfNextNegativeSample:c,epochsPerNegativeSample:l,moveOther:u,initialAlpha:r,alpha:r,gamma:e,dim:h})},t.prototype.initializeOptimization=function(){var t=this.embedding,e=this.embedding,r=this.optimizationState,n=r.head,i=r.tail,o=r.epochsPerSample,a=this.getNEpochs(),s=this.graph.nCols,h=ct(this.spread,this.minDist),u=h.a,l=h.b;this.assignOptimizationStateParameters({headEmbedding:t,tailEmbedding:e,head:n,tail:i,epochsPerSample:o,a:u,b:l,nEpochs:a,nVertices:s})},t.prototype.optimizeLayoutStep=function(t){for(var e=this.optimizationState,r=e.head,n=e.tail,i=e.headEmbedding,o=e.tailEmbedding,a=e.epochsPerSample,s=e.epochOfNextSample,h=e.epochOfNextNegativeSample,u=e.epochsPerNegativeSample,l=e.moveOther,c=e.initialAlpha,f=e.alpha,p=e.gamma,v=e.a,d=e.b,m=e.dim,g=e.nEpochs,y=e.nVertices,S=0;S<a.length;S++)if(!(s[S]>t)){var b=r[S],w=n[S],M=i[b],z=o[w],N=lt(M,z),_=0;N>0&&(_=-2*v*d*Math.pow(N,d-1),_/=v*Math.pow(N,d)+1);for(var k=0;k<m;k++){var E=ut(_*(M[k]-z[k]),4);M[k]+=E*f,l&&(z[k]+=-E*f)}s[S]+=a[S];for(var x=Math.floor((t-h[S])/u[S]),P=0;P<x;P++){var R=rt.tauRandInt(y,this.random),O=o[R],C=lt(M,O),F=0;if(C>0)F=2*p*d,F/=(.001+C)*(v*Math.pow(C,d)+1);else if(b===R)continue;for(k=0;k<m;k++){E=4;F>0&&(E=ut(F*(M[k]-O[k]),4)),M[k]+=E*f}}h[S]+=x*u[S]}return e.alpha=c*(1-t/g),e.currentEpoch+=1,i},t.prototype.optimizeLayoutAsync=function(t){var e=this;return void 0===t&&(t=function(){return!0}),new Promise((function(r,n){var i=function(){return X(e,void 0,void 0,(function(){var e,o,a,s,h,u;return Z(this,(function(l){try{if(e=this.optimizationState,o=e.nEpochs,a=e.currentEpoch,this.embedding=this.optimizeLayoutStep(a),s=this.optimizationState.currentEpoch,h=!1===t(s),u=s===o,h||u)return[2,r(u)];setTimeout((function(){return i()}),0)}catch(t){n(t)}return[2]}))}))};setTimeout((function(){return i()}),0)}))},t.prototype.optimizeLayout=function(t){void 0===t&&(t=function(){return!0});for(var e=!1,r=[];!e;){var n=this.optimizationState,i=n.nEpochs,o=n.currentEpoch;r=this.optimizeLayoutStep(o);var a=this.optimizationState.currentEpoch,s=!1===t(a);e=a===i||s}return r},t.prototype.getNEpochs=function(){var t=this.graph;if(this.nEpochs>0)return this.nEpochs;var e=t.nRows;return e<=2500?500:e<=5e3?400:e<=7500?300:200},t}();function st(t,e){for(var r=0,n=0;n<t.length;n++)r+=Math.pow(t[n]-e[n],2);return Math.sqrt(r)}n.UMAP=at,n.euclidean=st,n.cosine=function(t,e){for(var r=0,n=0,i=0,o=0;o<t.length;o++)r+=t[o]*e[o],n+=Math.pow(t[o],2),i+=Math.pow(e[o],2);return 0===n&&0===i?0:0===n||0===i?1:1-r/Math.sqrt(n*i)};var ht=function(){this.currentEpoch=0,this.headEmbedding=[],this.tailEmbedding=[],this.head=[],this.tail=[],this.epochsPerSample=[],this.epochOfNextSample=[],this.epochOfNextNegativeSample=[],this.epochsPerNegativeSample=[],this.moveOther=!0,this.initialAlpha=1,this.alpha=1,this.gamma=1,this.a=1.5769434603113077,this.b=.8950608779109733,this.dim=2,this.nEpochs=500,this.nVertices=0};function ut(t,e){return t>e?e:t<-e?-e:t}function lt(t,e){for(var r=0,n=0;n<t.length;n++)r+=Math.pow(t[n]-e[n],2);return r}function ct(t,e){var r=rt.linear(0,3*t,300).map((function(t){return t<e?1:t})),n=rt.zeros(r.length).map((function(n,i){return r[i]>=e?Math.exp(-(r[i]-e)/t):n})),i={x:r,y:n},o={damping:1.5,initialValues:[.5,.5],gradientDifference:.1,maxIterations:100,errorTolerance:.01},a=nt.default(i,(function(t){var e=Q(t,2),r=e[0],n=e[1];return function(t){return 1/(1+r*Math.pow(t,2*n))}}),o).parameterValues,s=Q(a,2);return{a:s[0],b:s[1]}}function ft(t,e,r,n){return void 0===r&&(r=1),void 0===n&&(n=5),t.map((function(t,i,o){return-1===e[i]||-1===e[o]?t*Math.exp(-r):e[i]!==e[o]?t*Math.exp(-n):t}))}function pt(t){t=$.normalize(t,"max");var e=$.transpose(t),r=$.pairwiseMultiply(e,t);return t=$.add(t,$.subtract(e,r)),$.eliminateZeros(t)}function vt(t,e,r){for(var n=rt.zeros(t.length).map((function(t){return rt.zeros(r[0].length)})),i=0;i<t.length;i++)for(var o=0;o<t[0].length;o++)for(var a=0;a<r[0].length;a++){var s=t[i][o];n[i][a]+=e[i][o]*r[s][a]}return n}n.findABParams=ct,n.fastIntersection=ft,n.resetLocalConnectivity=pt,n.initTransform=vt,Object.defineProperty(r,"__esModule",{value:!0});var dt=n,mt=r.UMAP=dt.UMAP,gt=r.__esModule;export{mt as UMAP,gt as __esModule,r as default};
